language: minimal

services:
  - docker

env:
  global:
    - SHA=$(git rev-parse HEAD)

before_install:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker build -t janakasteph/tmp -f ./client/Dockerfile.dev ./client

  # Get doctl
  - DOCTL_VERSION=`curl "https://api.github.com/repos/digitalocean/doctl/releases/latest" | jq -r .tag_name | sed "s/v//"`
  - curl -LO "https://github.com/digitalocean/doctl/releases/download/v${DOCTL_VERSION}/doctl-${DOCTL_VERSION}-linux-amd64.tar.gz"
  - tar xf ./doctl-${DOCTL_VERSION}-linux-amd64.tar.gz
  - chmod +x ./doctl
  - sudo mv ./doctl /usr/local/bin/doctl

  # Get kubectl
  - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
  - chmod +x ./kubectl
  - sudo mv ./kubectl /usr/local/bin/kubectl

  # Decode base64 KUBECONFIG env var and write it at ${HOME}/.kube/config
  - mkdir ${HOME}/.kube
  - echo "$KUBECONFIG" | base64 --decode > ${HOME}/.kube/config

  # - sudo apt update
  # - sudo apt install snap
  # - sudo snap install helm --classic

script:
  - docker run -e CI=true janakasteph/tmp yarn test

deploy:
  provider: script
  script: bash ./deploy.sh
  on:
    branch: k8s